FROM --platform=$BUILDPLATFORM ghcr.io/surface-security/compile-requirements:4 as requirements
ARG SCHEDULING_STRATEGY="eventbridge"

RUN --mount=type=bind,target=/tmpapp \
    STRATEGY_FILE=""; \
    if [ "$SCHEDULING_STRATEGY" = "dkron" ]; then \
        STRATEGY_FILE="/tmpapp/surface/requirements_dkron.txt"; \
    elif [ "$SCHEDULING_STRATEGY" = "kubernetes" ]; then \
        STRATEGY_FILE="/tmpapp/surface/requirements_kubernetes.txt"; \
    elif [ "$SCHEDULING_STRATEGY" = "eventbridge" ]; then \
        STRATEGY_FILE="/tmpapp/surface/requirements_aws.txt"; \
    else \
        echo "Unknown SCHEDULING_STRATEGY: $SCHEDULING_STRATEGY, defaulting to dkron"; \
        STRATEGY_FILE="/tmpapp/surface/requirements_dkron.txt"; \
    fi; \
    if [ -f "$STRATEGY_FILE" ]; then \
        python /run.py /tmpapp/surface/requirements_prod.txt \
                       /tmpapp/surface/requirements_psql.txt \
                       "$STRATEGY_FILE" > /requirements_full.txt; \
    else \
        echo "Strategy file $STRATEGY_FILE not found, using base requirements only"; \
        python /run.py /tmpapp/surface/requirements_prod.txt \
                       /tmpapp/surface/requirements_psql.txt > /requirements_full.txt; \
    fi
# Debug: Output the result
RUN cat /requirements_full.txt